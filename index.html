<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Privet ‚Äì Momentos dulces</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f5f5f5;
      /* padding: 20px; */
      margin: 0;
    }

    video,
    canvas,
    img {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      border: 1px solid #ccc;
    }

    .overlay-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(101, 139, 199, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      transition: all 0.2s ease;
    }

    .overlay-btn:hover {
      background: rgba(79, 111, 168, 1);
      transform: scale(1.05);
    }

    .video-wrapper {
      position: relative;
      display: inline-block;
      border-radius: 8px;
      overflow: hidden;
      /* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –≤—ã–ª–µ–∑–∞–ª–∞ –∑–∞ –∫—Ä–∞—è */
    }

    button,
    input[type=file] {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      font-size: 1rem;
      width: 90%;
      max-width: 400px;
      margin: 1rem auto;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    input[type="range"] {
      accent-color: #658bc7;
      /* —Ç–≤–æ–π —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç */
      width: 100%;
    }

    .photo-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button,
    .file-btn {
      background: #658bc7;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover,
    .file-btn:hover {
      background: #4f6fa8;
    }

    button:active,
    .file-btn:active {
      background: #3e5b8a;
    }

    .separator {
      color: #555;
      font-weight: bold;
    }

    .file-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-btn input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
  </style>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>

<body>
  <h2>üì∏ ¬°Guarda tu momento m√°s dulce con nosotros!</h2>
  <div id="photo">
    <div class="video-wrapper">
      <video id="video" autoplay playsinline></video>
      <button id="switchCamera" class="overlay-btn">üîÑ</button>
    </div>
    <div class="photo-controls">
      <button id="snap">üì∏ Tomar foto</button>
      <span class="separator">o</span>
      <label class="file-btn">
        üìÇ Subir foto
        <input type="file" accept="image/*" id="upload" hidden>
      </label>
    </div>
  </div>

  <div id="preview" hidden>
    <canvas id="originalCanvas"></canvas>
    <canvas id="previewCanvas"></canvas>
    <canvas id="previewPrinterCanvas"></canvas>

    <canvas id="finalPreviewCanvas"></canvas>
    <canvas id="printerCanvas"></canvas>

    <div class="controls">
      <label>
        ‚òÄÔ∏è Brillo
        <input type="range" id="brightness" min="0" max="100" value="50" step="1">
        <span id="brightnessValue">50</span>
      </label>

      <label>
        üåì Contraste
        <input type="range" id="contrast" min="0" max="100" value="50" step="1">
        <span id="contrastValue">50</span>
      </label>
    </div>
    <button id="otherPhoto">Tomar otra foto</button>
    <button id="print">üñ®Ô∏è Imprimir</button>
  </div>

  <script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è ---
    const video = document.getElementById('video');
    let currentFacingMode = "user";
    let stream = null;

    async function startCamera(facingMode) {
      // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 526,
            height: 526,
            facingMode: { exact: facingMode }
          }
        });
      } catch (e) {
        // –ï—Å–ª–∏ exact –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ), –ø—Ä–æ–±—É–µ–º –±–µ–∑ exact
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 526,
            height: 526,
            facingMode: facingMode
          }
        });
      }
      video.srcObject = stream;
      // –û—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏–µ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã
      if (facingMode === "user") {
        video.style.transform = "scaleX(-1)";
      } else {
        video.style.transform = "none";
      }
    }

    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
    document.getElementById("switchCamera").onclick = async () => {
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      await startCamera(currentFacingMode);
    };

    // –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    startCamera(currentFacingMode);

    // --- –°—ä—ë–º–∫–∞ —Ñ–æ—Ç–æ ---
    const originalCanvas = document.getElementById('originalCanvas');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewPrinterCanvas = document.getElementById('previewPrinterCanvas');
    const finalPreviewCanvas = document.getElementById('finalPreviewCanvas');
    const printerCanvas = document.getElementById('printerCanvas');
    // const preview = document.getElementById('preview');

    document.getElementById('snap').onclick = () => {
      const ctxDraft = originalCanvas.getContext('2d');
      originalCanvas.width = previewCanvas.width = 526;
      originalCanvas.height = previewCanvas.height = 526;

      if (currentFacingMode === "user") {
        // –û—Ç—Ä–∞–∑–∏—Ç—å –ø–æ X
        ctxDraft.translate(originalCanvas.width, 0);
        ctxDraft.scale(-1, 1);
        ctxDraft.drawImage(video, 0, 0, originalCanvas.width, originalCanvas.height);
        ctxDraft.setTransform(1, 0, 0, 1, 0, 0); // —Å–±—Ä–æ—Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
      } else {
        ctxDraft.drawImage(video, 0, 0, originalCanvas.width, originalCanvas.height);
      }

      error_diffusion(previewCanvas, originalCanvas);
      error_diffusion(previewPrinterCanvas, originalCanvas, 40);

      document.getElementById('photo').style.display = "none";
      document.getElementById('preview').style.display = "block";
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ä—è–¥–æ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    ["brightness", "contrast"].forEach(id => {
      const input = document.getElementById(id);
      const label = document.getElementById(id + "Value");
      input.addEventListener("input", () => {
        label.textContent = input.value;
        error_diffusion(previewCanvas, originalCanvas);
        error_diffusion(previewPrinterCanvas, originalCanvas, 40);
      });
    });

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ ---
    document.getElementById('upload').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      const objectUrl = URL.createObjectURL(file);

      img.onload = () => {
        const ctxDraft = originalCanvas.getContext('2d');

        // --- –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ---
        const srcW = img.width;
        const srcH = img.height;

        // --- –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ (–ø–æ –º–µ–Ω—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ) ---
        const side = Math.min(srcW, srcH);

        // --- –æ–±—Ä–µ–∑–∞–µ–º –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ ---
        const sx = (srcW - side) / 2;
        const sy = (srcH - side) / 2;

        // --- –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä –∏—Ç–æ–≥–æ–≤–æ–≥–æ canvas ---
        const targetSize = 526;
        originalCanvas.width = targetSize;
        originalCanvas.height = targetSize;

        // --- —Ä–∏—Å—É–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç, –∑—É–º–∏–º –≤ 526 ---
        ctxDraft.drawImage(
          img,            // –∏—Å—Ç–æ—á–Ω–∏–∫
          sx, sy, side, side, // —á—Ç–æ –≤–∑—è—Ç—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
          0, 0, targetSize, targetSize // –∫—É–¥–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å
        );

        // --- –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ---
        error_diffusion(previewCanvas, originalCanvas);
        error_diffusion(previewPrinterCanvas, originalCanvas, 40);

        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –æ–±—ä–µ–∫—Ç
        URL.revokeObjectURL(objectUrl);

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ input, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
        e.target.value = '';
      };

      img.onerror = () => {
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –æ–±—ä–µ–∫—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        URL.revokeObjectURL(objectUrl);
        e.target.value = '';
      };

      img.src = objectUrl;

      document.getElementById('photo').style.display = "none";
      document.getElementById('preview').style.display = "block";
    };

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —á/–± ---
    function error_diffusion(destinationCanvas, sourceCanvas, shiftUp = 0) {

      const ctx = destinationCanvas.getContext("2d");

      const w = (sourceCanvas ? sourceCanvas.width : destinationCanvas.width);
      const h = (sourceCanvas ? sourceCanvas.height : destinationCanvas.height);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã destinationCanvas, –µ—Å–ª–∏ –µ—Å—Ç—å sourceCanvas
      if (sourceCanvas) {
        destinationCanvas.width = w;
        destinationCanvas.height = h;
      }

      const brightness = (sourceCanvas ? document.getElementById('brightness').value : 50);
      const contrast = (sourceCanvas ? document.getElementById('contrast').value : 50);

      if (sourceCanvas) {
        ctx.drawImage(sourceCanvas, 0, 0);
      }

      const imgData = ctx.getImageData(0, 0, w, h);
      const d = imgData.data;

      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;

          // –≤—ã—á–∏—Å–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å (0‚Äì255)
          const oldPixel = (0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2]) / 255 * (255 - shiftUp) + shiftUp

          const factor = (contrast - 50) / 50  // –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç -1 –¥–æ +1
          contrastFactor = Math.tan((factor + 1) * Math.PI / 4)
          let gray = (oldPixel - 128) * contrastFactor + 128

          gray = Math.max(0, Math.min(255, gray + (brightness - 50) * 2.55));

          const newPixel = gray < 128 ? 0 : 255; // –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è
          const error = gray - newPixel;

          // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          d[i] = d[i + 1] = d[i + 2] = newPixel;

          // —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—à–∏–±–∫—É –ø–æ —Å–æ—Å–µ–¥—è–º (7, 3, 5, 1)
          // —Å–ø—Ä–∞–≤–∞
          if (x + 1 < w) {
            const idx = (y * w + (x + 1)) * 4;
            const v = d[idx] + (error * 7) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑-–≤–ª–µ–≤–æ
          if (x > 0 && y + 1 < h) {
            const idx = ((y + 1) * w + (x - 1)) * 4;
            const v = d[idx] + (error * 3) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑
          if (y + 1 < h) {
            const idx = ((y + 1) * w + x) * 4;
            const v = d[idx] + (error * 5) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑-–≤–ø—Ä–∞–≤–æ
          if (x + 1 < w && y + 1 < h) {
            const idx = ((y + 1) * w + (x + 1)) * 4;
            const v = d[idx] + (error * 1) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
        }
      }

      // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ canvas
      ctx.putImageData(imgData, 0, 0);

      if (sourceCanvas) {
        composeFinal(finalPreviewCanvas, previewCanvas);
        composeFinal(printerCanvas, previewPrinterCanvas);
      }

    }

    document.getElementById('otherPhoto').onclick = () => {
      document.getElementById('photo').style.display = "block";
      document.getElementById('preview').style.display = "none";
    }

    function composeFinal(destinationCanvas, sourceCanvas) {
      const frameSrc = 'Polaroid.png'; // –ø—É—Ç—å –∫ —à–∞–±–ª–æ–Ω—É (PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –æ–∫–Ω–æ–º)
      const frame = new Image();

      frame.onload = function () {
        const ctxFinal = destinationCanvas.getContext('2d');

        // –ø–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ —à–∞–±–ª–æ–Ω
        destinationCanvas.width = frame.width;
        destinationCanvas.height = frame.height;

        // —Ä–∏—Å—É–µ–º —Ä–∞–º–∫—É
        ctxFinal.drawImage(frame, 0, 0);

        // –ø–æ–¥–ø–∏—Å—å –ø–æ–¥ —Ñ–æ—Ç–æ
        ctxFinal.font = "bold 18px Arial";
        ctxFinal.fillStyle = "#333";

        // –ø–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
        const now = new Date();

        // —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ DD.MM.YYYY
        const formattedDate = now.toLocaleDateString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });

        // —Ä–∏—Å—É–µ–º –¥–∞—Ç—É –Ω–∞ canvas
        ctxFinal.fillText(formattedDate, 450, 680);

        error_diffusion(destinationCanvas);

        // –≤—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø—Ä–µ–≤—å—é
        const photoX = 17;  // –ø–æ–∑–∏—Ü–∏—è —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏
        const photoY = 17;
        const photoW = 526;
        const photoH = 526;

        ctxFinal.drawImage(
          sourceCanvas,
          0, 0, sourceCanvas.width, sourceCanvas.height,
          photoX, photoY, photoW, photoH
        );

        // thinOutPrint();
      };

      // –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–º–∫–∏
      frame.src = frameSrc;
    }

    function thinOutPrint() {

      const ctx = printerCanvas.getContext("2d");

      const w = (finalPreviewCanvas ? finalPreviewCanvas.width : printerCanvas.width);
      const h = (finalPreviewCanvas ? finalPreviewCanvas.height : printerCanvas.height);

      printerCanvas.width = w;
      printerCanvas.height = h;

      ctx.drawImage(finalPreviewCanvas, 0, 0);

      const imgData = ctx.getImageData(0, 0, w, h);
      const d = imgData.data;

      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;

          const oldPixel = (0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2])
          const newPixel = oldPixel < 128 ? 0 : 255; // –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è

          // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

          // d[i] = d[i + 1] = d[i + 2] = newPixel <= 128 ? (Math.random() * 100 <= 10 ? 255 : 0) : 255; // –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ
          // d[i] = d[i + 1] = d[i + 2] = ((x + y + Math.round(Math.random() * 2)) % 6 ? newPixel : 255); // –≤—ã—á–∏—Ç–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –Ω –ø–∏–∫—Å–µ–ª—è
          // d[i] = d[i + 1] = d[i + 2] = newPixel;
          // d[i] = d[i + 1] = d[i + 2] = ((x + y) % 4) ? 255 : 0; // –∑–∞–ª–∏–≤–∫–∞
          // d[i] = d[i + 1] = d[i + 2] = ((x + y) % (Math.ceil(y / 100) + 1)) ? 255 : 0; // –∑–∞–ª–∏–≤–∫–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
          if (x > 2) {
            let sum = 0;
            sum += d[(y * w + (x - 1)) * 4];
            sum += d[(y * w + (x - 2)) * 4];
            sum += d[(y * w + (x - 3)) * 4];

            sum = Math.round(sum / 255);

            // d[i] = d[i + 1] = d[i + 2] = (sum < 2 && Math.random() * 100 <= 20) ? 255 : newPixel; // –∑–∞–ª–∏–≤–∫–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
          }

        }
      }

      // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ canvas
      ctx.putImageData(imgData, 0, 0);

    }

    // --- –ö–Ω–æ–ø–∫–∞ "–ü–µ—á–∞—Ç—å" —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è ---
    let isPrinting = false;

    const printBtn = document.getElementById('print');

    printBtn.onclick = async () => {
      if (isPrinting) return;

      isPrinting = true;
      printBtn.disabled = true;

      // –ò–∑–º–µ–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
      const originalText = printBtn.innerHTML;
      printBtn.innerHTML = "üñ®Ô∏è Imprimiendo...";
      printBtn.style.background = "#aaa";

      let printSuccess = false;
      try {
        console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ –ø–µ—á–∞—Ç—å...");

        // –¢–∞–π–º–∞—É—Ç-–ø—Ä–æ–º–∏—Å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—á–∞—Ç–∏
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error("Tiempo de espera agotado")), 3000)
        );
        await Promise.race([
          sendToPrinter(),
          timeoutPromise
        ]);

        printBtn.innerHTML = "‚úÖ ¬°Impresi√≥n completada! Espera 15‚ÄØsegundos antes de la siguiente impresi√≥n.";
        printBtn.style.background = "#4CAF50"; // –∑–µ–ª—ë–Ω—ã–π
        printSuccess = true;
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏:", e);
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏
        const msg = (e && e.message) ? e.message : String(e);
        if (
          msg.includes("Tiempo de espera agotado") ||
          msg.includes("TypeError")
        ) {
          alert("‚ö†Ô∏è No se pudo conectar con la impresora. Aseg√∫rate de estar conectado a nuestro Wi‚ÄëFi.");
        } else {
          alert("‚ùå Error de impresi√≥n. Por favor, int√©ntalo de nuevo.");
        }
        printSuccess = false;
      } finally {
        if (printSuccess) {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
          setTimeout(() => {
            isPrinting = false;
            printBtn.disabled = false;
            printBtn.innerHTML = originalText;
            printBtn.style.background = ""; // –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∏–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          }, 15000);
        } else {
          // –û—à–∏–±–∫–∞ ‚Äî —Å—Ä–∞–∑—É —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          isPrinting = false;
          printBtn.disabled = false;
          printBtn.innerHTML = originalText;
          printBtn.style.background = "";
        }
      }
    };

    function canvasTo1bitBase64(canvas) {
      // 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ä–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–∞
      const ctx = canvas.getContext("2d");
      const { width, height } = canvas;

      // 2Ô∏è‚É£ –°—á–∏—Ç—ã–≤–∞–µ–º –ø–∏–∫—Å–µ–ª–∏ RGBA (–ø–æ 4 –±–∞–π—Ç–∞ –Ω–∞ –ø–∏–∫—Å–µ–ª—å)
      const imgData = ctx.getImageData(0, 0, width, height);
      const data = imgData.data;

      // 3Ô∏è‚É£ –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ –±–∞–π—Ç –Ω—É–∂–Ω–æ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (8 –ø–∏–∫—Å–µ–ª–µ–π = 1 –±–∞–π—Ç)
      const rowBytes = Math.ceil(width / 8);

      // 4Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ –ø–æ–¥ –∏—Ç–æ–≥–æ–≤–æ–µ –±–∏–Ω–∞—Ä–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (1 –±–∏—Ç –Ω–∞ –ø–∏–∫—Å–µ–ª—å)
      const mono = new Uint8Array(rowBytes * height);

      // 5Ô∏è‚É£ –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {

          // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –ø–∏–∫—Å–µ–ª—è –≤ –º–∞—Å—Å–∏–≤–µ RGBA
          const i = (y * width + x) * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          // 6Ô∏è‚É£ –í—ã—á–∏—Å–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ñ–æ—Ä–º—É–ª–µ (0‚Äì255)
          const gray = 0.299 * r + 0.587 * g + 0.114 * b;

          // 7Ô∏è‚É£ –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—ë—Ä–Ω—ã–π (1) –∏–ª–∏ –±–µ–ª—ã–π (0)
          // –ü–æ—Ä–æ–≥ 128 –º–æ–∂–Ω–æ —Å–¥–≤–∏–≥–∞—Ç—å –¥–ª—è —Å–≤–µ—Ç–ª–µ–µ/—Ç–µ–º–Ω–µ–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
          const bit = gray < 128 ? 1 : 0;

          // 8Ô∏è‚É£ –í—ã—á–∏—Å–ª—è–µ–º, –≤ –∫–∞–∫–æ–π –±–∞–π—Ç –∏ –≤ –∫–∞–∫—É—é –ø–æ–∑–∏—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ –±–∞–π—Ç–∞ –ø–∏—Å–∞—Ç—å –±–∏—Ç

          // (x >> 3) = x / 8, —Ü–µ–ª–∞—è —á–∞—Å—Ç—å ‚Äî –∫–∞–∫–æ–π —ç—Ç–æ –±–∞–π—Ç –≤ —Å—Ç—Ä–æ–∫–µ
          // (x & 7)  = x % 8 ‚Äî –∫–∞–∫–æ–π –ø–æ —Å—á—ë—Ç—É –ø–∏–∫—Å–µ–ª—å –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –±–∞–π—Ç–∞ (0‚Äì7)
          // 7 - (...) ‚Äî —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π –ø–∏–∫—Å–µ–ª—å –±—ã–ª —Å—Ç–∞—Ä—à–∏–º –±–∏—Ç–æ–º (—Å–ª–µ–≤–∞)
          const byteIndex = y * rowBytes + (x >> 3);
          const bitPos = 7 - (x & 7);

          // 9Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –±–∏—Ç –≤ –±–∞–π—Ç–µ
          // 1 << bitPos —Å–æ–∑–¥–∞—ë—Ç –º–∞—Å–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 00100000),
          // –∞ |= –¥–æ–±–∞–≤–ª—è–µ—Ç –µ—ë –≤ –±–∞–π—Ç, –Ω–µ —Ç—Ä–æ–≥–∞—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∏—Ç—ã
          if (bit) mono[byteIndex] |= 1 << bitPos;
        }
      }

      // üîü –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤ (Uint8Array) –≤ base64 —Å—Ç—Ä–æ–∫—É
      // –î–µ–ª–∞–µ–º –ø–æ –∫—É—Å–∫–∞–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–µ–∫ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      let binary = "";
      const chunk = 0x8000; // ~32 –ö–ë
      for (let i = 0; i < mono.length; i += chunk) {
        const slice = mono.subarray(i, i + chunk);
        binary += String.fromCharCode.apply(null, slice);
      }

      // 1Ô∏è‚É£1Ô∏è‚É£ –ö–æ–¥–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ base64 ‚Äî –≥–æ—Ç–æ–≤–æ –∫ –ø–µ—Ä–µ–¥–∞—á–µ
      return btoa(binary);
    }

    // --- –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ ---
    async function sendToPrinter() {
      const finalPreviewCanvas = document.getElementById('finalPreviewCanvas');
      const width = finalPreviewCanvas.width;
      const height = finalPreviewCanvas.height;
      const base64mono = canvasTo1bitBase64(printerCanvas);
      // console.log(base64mono);
      const xml = `<epos-print><image width="${width}" height="${height}" color="mono" mode="graphic">${base64mono}</image><cut type="feed"/></epos-print>`;
      const response = await fetch(
        "http://192.168.10.170:8080/cgi-bin/epos/service.cgi?devid=local_printer",
        {
          method: "POST",
          headers: {
            "Content-Type": "text/plain"
          },
          body: xml
        }
      );
      const text = await response.text();
      console.log("Printer response:", text);
    }
  </script>
</body>

</html>