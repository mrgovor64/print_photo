<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–§–æ—Ç–æ –¥–ª—è –ø–µ—á–∞—Ç–∏</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f5f5f5;
      padding: 20px;
    }

    video,
    canvas,
    img {
      width: 600px;
      height: 600px;
      /* object-fit: cover; */
      margin: 10px auto;
      border: 1px solid #ccc;
    }

    button,
    input[type=file] {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <h2>üì∏ –°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</h2>

  <video id="video" autoplay playsinline></video><br>
  <button id="snap">–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <input type="file" accept="image/*" id="upload">

  <canvas id="canvasDraft"></canvas>
  <canvas id="canvasUpdated"></canvas>
  <h3>–ß—ë—Ä–Ω–æ-–±–µ–ª–æ–µ –ø—Ä–µ–≤—å—é:</h3>
  <img id="preview" alt="–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" /><br>
  <button id="print">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
  <input type="number" value="50" min="0" max="100" step="5" id="brightness">
  <input type="number" value="50" min="5" max="100" step="5" id="contrast">

  <script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã ---
    const video = document.getElementById('video');
    navigator.mediaDevices.getUserMedia({
      video: {
        width: 600,
        height: 600
      }
    }).then(stream => {
      video.srcObject = stream;
    });

    // --- –°—ä—ë–º–∫–∞ —Ñ–æ—Ç–æ ---
    const canvas = document.getElementById('canvasDraft');
    const canvasUpdated = document.getElementById('canvasUpdated');
    const preview = document.getElementById('preview');
    document.getElementById('snap').onclick = () => {
      const ctxDraft = canvas.getContext('2d');

      console.log(video.videoWidth);
      console.log(video.videoHeight);

      // canvas.width = video.videoWidth;
      // canvas.height = video.videoHeight;
      canvas.width = canvasUpdated.width = 600;
      canvas.height = canvasUpdated.height = 600;
      ctxDraft.drawImage(video, 0, 0);
      processImage();
    };

    document.getElementById('brightness').onchange = () => {
      processImage();
    };

    document.getElementById('contrast').onchange = () => {
      processImage();
    };


    // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ ---
    document.getElementById('upload').onchange = e => {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        const ctxDraft = canvas.getContext('2d');

        // --- –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã ---
        const srcW = img.width;
        const srcH = img.height;

        // --- –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ (–ø–æ –º–µ–Ω—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ) ---
        const side = Math.min(srcW, srcH);

        // --- –æ–±—Ä–µ–∑–∞–µ–º –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ ---
        const sx = (srcW - side) / 2;
        const sy = (srcH - side) / 2;

        // --- –∑–∞–¥–∞—ë–º —Ä–∞–∑–º–µ—Ä –∏—Ç–æ–≥–æ–≤–æ–≥–æ canvas ---
        const targetSize = 600;
        canvas.width = targetSize;
        canvas.height = targetSize;

        // --- —Ä–∏—Å—É–µ–º –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç, –∑—É–º–∏–º –≤ 600√ó600 ---
        ctxDraft.drawImage(
          img,            // –∏—Å—Ç–æ—á–Ω–∏–∫
          sx, sy, side, side, // —á—Ç–æ –≤–∑—è—Ç—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
          0, 0, targetSize, targetSize // –∫—É–¥–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å
        );

        // --- –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ---
        processImage();
      };

      img.src = URL.createObjectURL(file);
    };

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —á/–± ---
    function processImage() {
      const brightness = document.getElementById('brightness').value;
      const contrast = document.getElementById('contrast').value;

      const ctxUpdated = canvasUpdated.getContext("2d");
      const { width: w, height: h } = canvas;
      ctxUpdated.drawImage(canvas, 0, 0);

      const imgData = ctxUpdated.getImageData(0, 0, w, h);
      const d = imgData.data;

      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–∏–∫—Å–µ–ª—è–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;

          // –≤—ã—á–∏—Å–ª—è–µ–º —è—Ä–∫–æ—Å—Ç—å (0‚Äì255)

          const oldPixel = (0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2])

          const factor = (contrast - 50) / 50  // –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç -1 –¥–æ +1
          contrastFactor = Math.tan((factor + 1) * Math.PI / 4)
          let gray = (oldPixel - 128) * contrastFactor + 128

          gray = Math.max(0, Math.min(255, gray + (brightness - 50) * 2.55));

          const newPixel = gray < 128 ? 0 : 255; // –±–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è
          const error = gray - newPixel;

          // –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          d[i] = d[i + 1] = d[i + 2] = newPixel;

          // —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—à–∏–±–∫—É –ø–æ —Å–æ—Å–µ–¥—è–º (7, 3, 5, 1)
          // —Å–ø—Ä–∞–≤–∞
          if (x + 1 < w) {
            const idx = (y * w + (x + 1)) * 4;
            const v = d[idx] + (error * 7) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑-–≤–ª–µ–≤–æ
          if (x > 0 && y + 1 < h) {
            const idx = ((y + 1) * w + (x - 1)) * 4;
            const v = d[idx] + (error * 3) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑
          if (y + 1 < h) {
            const idx = ((y + 1) * w + x) * 4;
            const v = d[idx] + (error * 5) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
          // –≤–Ω–∏–∑-–≤–ø—Ä–∞–≤–æ
          if (x + 1 < w && y + 1 < h) {
            const idx = ((y + 1) * w + (x + 1)) * 4;
            const v = d[idx] + (error * 1) / 16;
            d[idx] = d[idx + 1] = d[idx + 2] = v;
          }
        }
      }

      // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ canvas
      ctxUpdated.putImageData(imgData, 0, 0);
      // preview.src = canvasUpdated.toDataURL("image/png");
    }

    // --- –ö–Ω–æ–ø–∫–∞ "–ü–µ—á–∞—Ç—å" ---
    document.getElementById('print').onclick = async () => {
      const data = canvas.toDataURL('image/png');
      console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ –ø–µ—á–∞—Ç—å...");
      await sendToPrinter(data);
      alert("–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—á–∞—Ç—å!");
    };

    // --- –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ ---
    async function sendToPrinter(imageData) {
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Ç–≤–æ–µ–º—É Flask-—Å–µ—Ä–≤–µ—Ä—É:
      // await fetch('http://raspberrypi:8080/print', {
      //   method: 'POST',
      //   headers: {'Content-Type':'application/json'},
      //   body: JSON.stringify({image: imageData})
      // });
      console.log("–ü—Å–µ–≤–¥–æ–æ—Ç–ø—Ä–∞–≤–∫–∞", imageData.slice(0, 50) + "...");
    }
  </script>
</body>

</html>